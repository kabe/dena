<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Web とサーバのイントロダクション</title>
    <meta name="Description" content="" />
    <meta name="Keywords"  content="" />
    <link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
  </head>
  <body>
    <!-- generated by: jsdo.it - http://jsdo.it/os0x/slide -->
    <!-- Copyright os0x - http://jsdo.it/os0x -->
    <!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
    <div class="slide">
      <h1>Webとサーバの<br />イントロダクション</h1>
      <p align="right">〜Web ってどうして動いてるの？〜</p>
      <p style="padding-top: 5em;" align="center">2011/08/18<br />加辺 友也(<a href="http://twitter.com/limitusus">Twitter</a>, <a href="http://d.hatena.ne.jp/limitusus/">hatena</a>, <a href="http://facebook.com/tomoya.kabe">Facebook</a>)</p>
    </div>
    <div class="slide">
      <h1>おことわり</h1>
      <p align="center">手抜き感でいっぱいです！！！</p>
    </div>
    <div class="slide">
      <h2>自己紹介</h2>
      <ul>
        <li>加辺 友也（かべ ともや）</li>
        <li>東京大学大学院（情報理工）M2</li>
        <li>専門は並列分散処理</li>
        <li><s>800台</s>600台くらいのマシンの管理者<br /><em>200台くらい震災で捨てた</em></li>
        <li><strong>母語はPerl</strong></li>
        <li>サーバエンジニア &amp; プログラマ</li>
        <li>Emacs も Vim も使います</li>
        <li>英字キーボード派</li>
        <li>インドア派</li>
        <li><a href="http://journal.mycom.co.jp/articles/2010/10/12/akara/index.html">あから2010</a>スタッフ</li>
      </ul>
    </div>
    <div class="slide">
      <h2>何が分かる人？</h2>
      <ul>
        <li>Linux は下から一通り分かる人です</li>
        <li><em>sh, Perl, Python</em>, Ruby, <em>C</em>, C++, PHP, Java, JavaScript あたりは普通<br />バイトではC#も</li>
        <li>窓？知らないなあ</li>
        <li>プログラマ歴12年のひよっこです</li>
      </ul>
    </div>
    <div class="slide">
      <h2>どうしてこうなった</h2>
      <ul>
        <li>かってぃ<br />「サーバ関係で10-20min、対象は初心者〜∞」</li>
        <li><strong>無理だろJK</strong></li>
      </ul>
      <h3>妥協</h3>
      <ul>
        <li>両方を満足させることは困難である</li>
        <li>半分ずつくらいの内容にしよう</li>
        <li>半分はイメージ、半分はプログラミング</li>
      </ul>
    </div>
    <div class="slide">
      <h2>こんな感じ</h2>
      <p align="center">
        <img src="large.png">
      </p>
    </div>
    <div class="slide">
      <h2>今回のテーマ</h2>
      <p>20分（くらい）でできるサーバ</p>
      <ul>
        <li>サーバって結局のところ何者？</li>
        <li>何が起こってるの？</li>
        <li>作ってみよう！</li>
      </ul>
    </div>
    <div class="slide">
      <h2>サーバって？</h2>
      <p>&quot;Server&quot;: ユーザー（クライアント）からの要求に対して何らかのサービスを提供するシステム (by <a href="http://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%BC%E3%83%90">Wikipedia</a>)</p>
      <p>よくわからない</p>
    </div>
    <div class="slide">
      <h2>つまりこういうこと</h2>
      <p align="center">
        <img src="sc.png" width="600" />
      </p>
    </div>
    <div class="slide">
      <h2>世の中のサーバはたくさんある</h2>
      <ul>
        <li>Web サーバ</li>
        <li>メールサーバ</li>
        <li>ネトゲサーバ</li>
        <li>データベースサーバ</li>
        <li>そのほか超たくさん</li>
      </ul>
    </div>
    <div class="slide">
      <h2>何ができればいいんでしょう？</h2>
      <p>定義を再掲...</p>
      <p>&quot;Server&quot;: ユーザー（クライアント）からの要求に対して何らかのサービスを提供するシステム (by <a href="http://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%BC%E3%83%90">Wikipedia</a>)</p>
      <p>少し整理してみよう</p>
    </div>
    <div class="slide">
      <h2>サーバで何が起きてるの？</h2>
      <p>定義から入力と出力を定義してみる</p>
      <ul>
        <li>入力: ユーザ（クライアント）からの要求</li>
        <li>出力: 「サービスの提供」</li>
      </ul>
      <p>なんだ、簡単そうじゃん</p>
    </div>
    <div class="slide">
      <h2>クライアントになってみよう</h2>
      <ul>
        <li>Webサーバを題材に</li>
        <li>普段はブラウザがやってくれてます</li>
        <li>今回はブラウザなしでやってみましょう</li>
      </ul>
    </div>
    <div class="slide">
      <h2>でも、難しいんでしょう？</h2>
      <p>実は結構めんどくさい
      <ol>
        <li>サーバに接続する←一番面倒</li>
        <li><em>サーバに要求を投げる</em></li>
        <li>サーバから結果を受けとる</li>
        <li>ユーザ（人間）に結果を見せる</li>
        <li>サーバへの接続を切断する</li>
      </ol>
      <p>今回は Telnet というツールを使ってほとんどを代行してもらいます</p>
    </div>
    <div class="slide">
      <h2>ホントに簡単なの？</h2>
      <ul>
        <li>簡単なことをする分には簡単です</li>
        <li>Windowsでもできます(7では以下の設定が必要)<br />
          <img src="win7_telnet.png" height="330">
        </li>
      </ul>
      <p class="comment" align="right">窓OSは知らないんじゃなかったの…？</p>
    </div>
    <div class="slide">
      <h2>クライアントになってみる</h2>
      <ul>
        <li><span class="cmd">&gt;&nbsp;telnet dena.jp 80</span> として接続</li>
        <li><span class="cmd">GET /</span> としてReturn</li>
        <li>たったこれだけで <a href="http://dena.jp/">http://dena.jp/</a> にアクセスしたことになる</li>
      </ul>
      <p class="comment"><s>補足: Windowsでは諸事情で文字化けします</s><br /><span style="color: red;">しない方法がありました</span><br />PowerShellを使って<br /><span class="cmd">&gt; [console]::InputEncoding=[text.encoding]::UTF8</span><br />してからならだいじょうぶ<br />実演はLinuxでやります</p>
    </div>
    <div class="slide">
      <h2>結果は…</h2>
      <pre class="longpre">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;
  &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;ja&quot; lang=&quot;ja&quot;&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
&lt;meta http-equiv=&quot;content-style-type&quot; content=&quot;text/css&quot; /&gt;
&lt;meta http-equiv=&quot;content-script-type&quot; content=&quot;text/javascript&quot; /&gt;
&lt;meta name=&quot;copyright&quot; content=&quot;&copy;DeNA Co.,Ltd.&quot; /&gt;
&lt;meta name=&quot;keywords&quot; content=&quot;DeNA,モバイル,eコマース,広告代理事業,ビッダーズ,モバオク,Mobage,モバコレ,ポケットビッダーズ,モバデパ,ポケットアフィリエイト&quot; /&gt;
&lt;meta name=&quot;description&quot; content=&quot;世界を切り拓く永久ベンチャー、株式会社ディー・エヌ・エー（DeNA）の公式ウェブサイトです。&quot; /&gt;
&lt;meta name=&quot;robots&quot; content=&quot;index,follow&quot; /&gt;
&lt;meta name=&quot;googlebot&quot; content=&quot;index,follow,archive&quot; /&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;/css/style.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;
&lt;link rel=&quot;shortcut icon&quot; type=&quot;image/x-icon&quot; href=&quot;/favicon.ico&quot; /&gt;
&lt;link rel=&quot;icon&quot; type=&quot;image/png&quot; href=&quot;/favicon.png&quot; /&gt;
&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;株式会社ディー・エヌ・エー プレスリリース RSS Feed&quot; href=&quot;http://www.dena.jp/press/atom.xml&quot; /&gt;
&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;株式会社ディー・エヌ・エー トピックス RSS Feed&quot; href=&quot;http://www.dena.jp/topics/atom.xml&quot; /&gt;
&lt;title&gt;[DeNA] 株式会社ディー・エヌ・エー&lt;/title&gt;
&lt;script type=&quot;text/javascript&quot;&gt;

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24340516-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

&lt;/script&gt;
&lt;/head&gt;
&lt;body class=&quot;top&quot;&gt;
  &lt;div id=&quot;header&quot;&gt;
    &lt;div class=&quot;inner&quot;&gt;
      &lt;h1 class=&quot;logo hover&quot;&gt;&lt;a href=&quot;/&quot; tabindex=&quot;1&quot;&gt;&lt;span&gt;株式会社ディー・エヌ・エー&lt;/span&gt;&lt;/a&gt;&lt;/h1&gt;
      </pre>
    </div>
    <div class="slide">
      <h2>わからん！</h2>
      <p>大丈夫、きっとブラウザがうまくやってくれます</p>
      <p>大事なのは<em>クライアントは結構単純</em>ということ</p>
    </div>
    <div class="slide">
      <h2>（再掲）世の中のサーバはたくさんある</h2>
      <ul>
        <li>Web サーバ</li>
        <li>メールサーバ</li>
        <li>ネトゲサーバ</li>
        <li>データベースサーバ</li>
        <li>そのほか超たくさん</li>
      </ul>
    </div>
    <div class="slide">
      <h2>そんなにたくさんあるなら</h2>
      <p>簡単に作れるはず！</p>
      <p><strong>実際に作ってみよう</strong><br />→今回は Web サーバを作ってみます</p>
      <p>というわけで、プログラミングパートのスタート</p>
    </div>
    <div class="slide">
      <h2>プログラミング言語の選定</h2>
      <ul>
        <li>正直<em>何だっていい</em>んですけど…</li>
        <li>この会社だし、やっぱりあの言語ですよね</li>
      </ul>
    </div>
    <div class="slide">
      <h2>Perl</h2>
      <ul>
        <li>結構昔から使われてる言語</li>
        <li>社内でも結構使われてるんじゃない？<br />mixiさんも使ってますね</li>
        <li>大部分のエンジニアはPerlで意思疎通ができるのでは？（もうそう）</li>
        <li><em>モジュールが豊富</em>←今回はここが重要</li>
        <li>加辺の母語</li>
      </ul>
      <p class="comment">結局これがやりたかっただけなんじゃ…？</p>
    </div>
    <div class="slide">
      <h2>モジュールを探す</h2>
      <ul>
        <li>モジュール＝先人の知恵</li>
        <li>あるなら使うべき</li>
        <li><a href="http://search.cpan.org/">CPAN</a>で検索だ！</li>
        <li>そして見付けた<a href="http://search.cpan.org/~jesse/HTTP-Server-Simple-0.44/lib/HTTP/Server/Simple.pm">HTTP::Server::Simple</a></li>
        <li>今回はこれの拡張<a href="http://search.cpan.org/~jesse/HTTP-Server-Simple-0.44/lib/HTTP/Server/Simple/CGI.pm">HTTP::Server::Simple::CGI</a>を利用します</li>
        <li><span class="cmd">$ yes | cpan HTTP::Server::Simple::CGI</span></li>
        <li>入力を受けて返す、これだけ</li>
      </ul>
    </div>
    <div class="slide">
      <h2>[ENG] Why CGI?</h2>
      <ul>
        <li>Famous CGI.pm-compatible interface</li>
        <li>We can get parameters from a user in a simple way</li>
      </ul>
    </div>
    <div class="slide">
      <h2>決まりごと=プロトコル</h2>
      <ul>
        <li>リクエストの送り方には決まりがあります</li>
        <li>今回は HTTP/1.0 というもの</li>
        <li><span class="cmd">GET /ほげほげ</span> が<br />
        <span class="cmd">http://サーバの場所/ほげほげ</span><br /> へのアクセスになる</li>
        <li>他にもいろいろ</li>
      </ul>
    </div>
    <div class="slide">
      <h2>基本機能の定義(1)</h2>
      <ul>
        <li>指定したディレクトリ以下に適当にコンテンツを配置しよう</li>
        <li>ファイルの場所を入力として、あったらそれを返す</li>
      </ul>
      <p>例: <span class="cmd">&quot;/A&quot;</span> =&gt; contents/A の中身を返す</p>
    </div>
    <div class="slide">
      <h2>基本機能の定義(2)</h2>
      <ul>
        <li>存在しないファイルが要求されたとき</li>
        <li>エラー画面を返す(今回は Not Found と言う)</li>
      </ul>
    </div>
    <div class="slide">
      <h2>ここまで簡単に作ってみた</h2>
      <pre style="font-size: large;">my $base_path = "contents/";  # 基準ディレクトリ

sub handle_request {  # リクエスト1つを処理する
    my ($self, $cgi) = @_;
  
    my $path = $cgi->path_info();
    # Search $path
    my $ok = 0;
    $ok = find_path(dir($base_path, $path));  # ファイル存在確認
    
    if ($ok) {  # ファイルあった
        print "HTTP/1.0 200 OK\r\n\n";
        # ファイルの中身を返す
        print load_content(dir($base_path, $path));
    }
    else {  # ファイルなかった
        print "HTTP/1.0 404 Not found\r\n";  # なかったと言う
        print $cgi->header,
            $cgi->start_html('Not found'),
                $cgi->h1("$path Not found"),
                    $cgi->end_html;
    }
}</pre>
    </div>
    <div class="slide">
      <h2>単純なものは単純</h2>
      <p>おわかりいただけただろうか？</p>
      <p class="comment">もうちょっとまともなものにしたいよねー</p>
    </div>
    <div class="slide">
      <h2>拡張機能の定義(1)</h2>
      <ul>
        <li>よくある機能</li>
        <li><span class="cmd">&quot;/&quot;</span>で終わったら自動的に <span class="cmd">index.html</span> を検索</li>
        <li>先ほどのKattyの発表にもありましたね</li>
        <li>別に普遍的にそうなってるんじゃなくて、サーバががんばるべきところです</li>
      </ul>
    </div>
    <div class="slide">
      <h2>拡張機能の定義(2)</h2>
      <ul>
        <li>ちょっとプログラムっぽく</li>
        <li><span class="cmd">&quot;/hello?name=名前&quot;</span>のときは「名前」に挨拶する</li>
      </ul>
    </div>
    <div class="slide">
      <h2>拡張機能(1)の実装</h2>
      <pre># ファイルなし & "/"で終わる
# index.html 付きで見付かったらそれを探してたことにする
if (!$ok && end_with_slash($path)) {
    $ok = find_path(dir($base_path, $path, "index.html"));
    if($ok) {
        $path = $path . "index.html";
    }
}

sub end_with_slash {  # "/"で終わるかどうかの判定
    my $path = shift;
    if ($path =~ m{/$}) {  # 正規表現という怪しい記述
        return 1;
    }
    return 0;
}</pre>
    </div>
    <div class="slide">
      <h2>拡張機能(2)の実装[1]</h2>
      <pre># dispatch table
my %dispatch = (
    '/hello' => \&resp_hello,  # 本体は次ページ
);

# %dispatch にあればサブルーチンリファレンス, なければ undef
my $handler = $dispatch{$path};
if ($ok) {
    ファイルが見付かった場合の処理（前と同じ）
}
elsif (ref($handler) eq "CODE") {  # %dispatch hit!
    print "HTTP/1.0 200 OK\r\n";
    $handler->($cgi);
}
else {
    ファイルが見付からなかった場合の処理（前と同じ）
}
</pre>
    </div>
    <div class="slide">
      <h2>拡張機能(2)の実装[2]</h2>
      <pre>sub resp_hello {  # "/hello" で呼ばれる
    my $cgi  = shift;
    return if !ref $cgi;

    my $who = $cgi->param('name');  # name=ほげほげ を解析
    if (!defined $who) {  # 実は指定されてなかったとき
        $who = "Someone"; # エラー回避処理
    }

    print $cgi->header,
    $cgi->start_html("Hello"),
    $cgi->h1("Hello $who!"),  # 挨拶部分
    $cgi->end_html;
}</pre>
    </div>
    <div class="slide">
      <h2>実際にやってみましょう</h2>
      <ul>
        <li>さっき家からここに来るまでに作った<a href="http://localhost:8081/hello?name=Moe">ネタ</a></li>
        <li>ここで作った<a href="http://localhost:8081/hello?name=Katty">ネタ</a></li>
      </ul>
    </div>
    <div class="slide">
      <h2>どうだったでしょうか？</h2>
      <ul>
        <li>プログラムは全体で100行くらいです
          <ul>
            <li>これだけでこんなに書ける</li>
            <li>これだけのことにこんなに書かないといけない</li>
          </ul>
          両面があると思います
        </li>
        <li>「サーバ」にはいろいろありますが、<br />基本は同じです</li>
      </ul>
      <h4>クラス継承（技術者向け）</h3>
      <pre style="font-size: large">HTTP::Server::Simple::CGI &lt;- MyServer &lt;- MyServer2
                            基本機能のみ   拡張機能つき</pre>
      <p>となっていました</p>
      </ul>
    </div>
    <div class="slide">
      <h2>実際のサーバでは？</h2>
      <ul>
        <li>もっと複雑なリクエストの処理</li>
        <li>並列動作</li>
        <li>アクセスログ</li>
        <li>アクセス制限</li>
      </ul>
      <p>などなど、様々な機能が実装されています<br />→DeNAのサービスを実現する技術の一部です</p>
    </div>
    <div class="slide">
      <h2>よだん</h2>
      <ul>
        <li>Kattyの発表で「index.pl では動かない」とありましたが</li>
        <li>自分で設定できるサーバならがんばれば動きます！</li>
      </ul>
    </div>
    <div class="slide">
      <h2>おわりに</h2>
      <ul>
        <li>サーバとは何かを説明</li>
        <li>Webサービスを実現するための基礎原理を紹介</li>
        <li>実際にサーバを作ってみた</li>
        <li>Perlで！</li>
      </ul>
      <h3>ちなみに</h3>
      <ul>
        <li>性能を出すためにはPerlでは遅すぎます</li>
        <li>普通Cで実装されたものが使われます</li>
        <li>コーディングは数倍複雑になります</li>
      </ul>
    </div>
    <div class="slide">
      <h2>利用させていただいたものたち</h2>
      <ul>
        <li>フォント: <a href="http://chiphead.jp/font/htm/cinecaption.htm">Cinecaption</a></li>
        <li>画像:
          <ul>
            <li><a href="http://to-a.ru/">とある櫻花の画像生成</a></li>
            <li><a href="http://www.cksinfo.com/holidays/halloween/demonsanddevils/index.html">cksinfo.com</a></li>
          </ul>
      </ul>
      <p align="center">Thanks for listening!</p>
    </div>
    <script type="text/javascript" src="index.js"></script>
  </body>
</html>
